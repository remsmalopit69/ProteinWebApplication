@{
    ViewBag.Title = "Images Management";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div ng-init="loadImages()">

    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h2 class="text-2xl font-bold text-gray-800">Images Library</h2>
            <p class="text-sm text-gray-600 mt-1" ng-if="!showArchived">Active images in your library</p>
            <p class="text-sm text-gray-600 mt-1" ng-if="showArchived">Archived images</p>
        </div>
        <div class="flex gap-3">
            <button ng-click="toggleArchivedView()"
                    class="px-4 py-2 rounded transition"
                    ng-class="showArchived ? 'bg-gray-500 text-white hover:bg-gray-600' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'">
                <i class="mr-2" ng-class="showArchived ? 'fas fa-eye' : 'fas fa-archive'"></i>
                {{showArchived ? 'View Active Images' : 'View Archived'}}
            </button>
            <button ng-if="!showArchived"
                    data-bs-toggle="modal"
                    data-bs-target="#imageModal"
                    class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition">
                <i class="fas fa-plus mr-2"></i>Upload Image
            </button>
        </div>
    </div>

    <!-- Filter by Type -->
    <div class="mb-6 flex gap-2 flex-wrap">
        <button ng-click="filterImageType = null"
                ng-class="{'bg-blue-500 text-white': !filterImageType, 'bg-gray-200 text-gray-700': filterImageType}"
                class="px-4 py-2 rounded hover:bg-blue-600 transition">
            All Images
        </button>
        <button ng-click="filterImageType = 'hero'"
                ng-class="{'bg-blue-500 text-white': filterImageType === 'hero', 'bg-gray-200 text-gray-700': filterImageType !== 'hero'}"
                class="px-4 py-2 rounded hover:bg-blue-600 transition">
            Hero Images
        </button>
        <button ng-click="filterImageType = 'product'"
                ng-class="{'bg-blue-500 text-white': filterImageType === 'product', 'bg-gray-200 text-gray-700': filterImageType !== 'product'}"
                class="px-4 py-2 rounded hover:bg-blue-600 transition">
            Products
        </button>
        <button ng-click="filterImageType = 'category'"
                ng-class="{'bg-blue-500 text-white': filterImageType === 'category', 'bg-gray-200 text-gray-700': filterImageType !== 'category'}"
                class="px-4 py-2 rounded hover:bg-blue-600 transition">
            Categories
        </button>
        <button ng-click="filterImageType = 'banner'"
                ng-class="{'bg-blue-500 text-white': filterImageType === 'banner', 'bg-gray-200 text-gray-700': filterImageType !== 'banner'}"
                class="px-4 py-2 rounded hover:bg-blue-600 transition">
            Banners
        </button>
        <button ng-click="filterImageType = 'feature'"
                ng-class="{'bg-blue-500 text-white': filterImageType === 'feature', 'bg-gray-200 text-gray-700': filterImageType !== 'feature'}"
                class="px-4 py-2 rounded hover:bg-blue-600 transition">
            Features
        </button>
        <button ng-click="filterImageType = 'about'"
                ng-class="{'bg-blue-500 text-white': filterImageType === 'about', 'bg-gray-200 text-gray-700': filterImageType !== 'about'}"
                class="px-4 py-2 rounded hover:bg-blue-600 transition">
            About
        </button>
    </div>

    <!-- Active Images Grid -->
    <div ng-if="!showArchived" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        <div ng-repeat="image in images | filter:{imageType: filterImageType}" class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-xl transition">
            <div class="relative">
                <img ng-src="{{image.imagePath}}" alt="{{image.imageName}}" class="w-full h-48 object-cover">
                <span ng-if="image.isAssigned" class="absolute top-2 right-2 bg-green-500 text-white text-xs px-2 py-1 rounded">
                    Assigned
                </span>
            </div>
            <div class="p-4">
                <h4 class="font-semibold text-gray-800 mb-2 truncate">{{image.imageName}}</h4>
                <p class="text-sm text-gray-600 mb-3">
                    <span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">
                        {{image.imageType}}
                    </span>
                </p>
                <div class="text-xs text-gray-500 mb-3">
                    Uploaded: {{image.createdAt | date:'MM/dd/yyyy'}}
                </div>
                <div class="flex gap-2">
                    <button ng-if="image.imageType === 'hero' || image.imageType === 'banner' || image.imageType === 'feature'"
                            ng-click="setAsActive(image.imageID, image.imageType)"
                            class="flex-1 bg-green-500 text-white text-xs px-3 py-2 rounded hover:bg-green-600 transition">
                        <i class="fas fa-check mr-1"></i>Set Active
                    </button>
                    <button ng-click="deleteImage(image.imageID)"
                            class="bg-red-500 text-white text-xs px-3 py-2 rounded hover:bg-red-600 transition">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Archived Images Grid -->
    <div ng-if="showArchived" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        <div ng-repeat="image in archivedImages | filter:{imageType: filterImageType}" class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-xl transition border-2 border-gray-300">
            <div class="relative">
                <img ng-src="{{image.imagePath}}" alt="{{image.imageName}}" class="w-full h-48 object-cover opacity-75">
                <span class="absolute top-2 left-2 bg-gray-700 text-white text-xs px-2 py-1 rounded">
                    <i class="fas fa-archive mr-1"></i>Archived
                </span>
                <span ng-if="image.isAssigned" class="absolute top-2 right-2 bg-orange-500 text-white text-xs px-2 py-1 rounded">
                    Was Assigned
                </span>
            </div>
            <div class="p-4">
                <h4 class="font-semibold text-gray-800 mb-2 truncate">{{image.imageName}}</h4>
                <p class="text-sm text-gray-600 mb-3">
                    <span class="inline-block bg-gray-100 text-gray-800 px-2 py-1 rounded text-xs">
                        {{image.imageType}}
                    </span>
                </p>
                <div class="text-xs text-gray-500 mb-1">
                    Uploaded: {{image.createdAt | date:'MM/dd/yyyy'}}
                </div>
                <div class="text-xs text-gray-500 mb-3">
                    Archived: {{image.updatedAt | date:'MM/dd/yyyy'}}
                </div>
                <div class="flex gap-2">
                    <button ng-click="restoreImage(image.imageID)"
                            class="flex-1 bg-green-500 text-white text-xs px-3 py-2 rounded hover:bg-green-600 transition">
                        <i class="fas fa-undo mr-1"></i>Restore
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- No Images Message -->
    <div ng-if="!showArchived && (images | filter:{imageType: filterImageType}).length === 0" class="text-center py-16 bg-gray-50 rounded-lg">
        <i class="fas fa-images text-gray-300 text-6xl mb-4"></i>
        <h3 class="text-xl font-bold text-gray-600 mb-2">No images found</h3>
        <p class="text-gray-500">Upload some images to get started</p>
    </div>

    <!-- No Archived Images Message -->
    <div ng-if="showArchived && (archivedImages | filter:{imageType: filterImageType}).length === 0" class="text-center py-16 bg-gray-50 rounded-lg">
        <i class="fas fa-archive text-gray-300 text-6xl mb-4"></i>
        <h3 class="text-xl font-bold text-gray-600 mb-2">No archived images found</h3>
        <p class="text-gray-500" ng-if="filterImageType">No archived images in the {{filterImageType}} category</p>
        <p class="text-gray-500" ng-if="!filterImageType">Archived images will appear here</p>
    </div>

    <!-- Upload Image Modal -->
    <div class="modal fade" id="imageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Upload Image</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="imageUploadForm" action="/Admin/UploadImage" method="post" enctype="multipart/form-data">
                        <div class="mb-4">
                            <label class="block text-gray-700 font-medium mb-2">Image File *</label>
                            <input type="file"
                                   name="imageFile"
                                   accept="image/*"
                                   class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   required>
                            <p class="text-xs text-gray-500 mt-1">Recommended: JPG, PNG, max 5MB</p>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 font-medium mb-2">Image Type *</label>
                            <select name="imageType"
                                    class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    required>
                                <option value="">Select Type</option>
                                <option value="hero">Hero Image (Homepage Banner)</option>
                                <option value="product">Product Image</option>
                                <option value="category">Category Image</option>
                                <option value="banner">Banner</option>
                                <option value="feature">Feature Section</option>
                                <option value="about">About Page</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">
                                Hero/Banner/Feature: Will be shown on homepage<br>
                                Product/Category: Assign later to specific items
                            </p>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 font-medium mb-2">Reference ID (Optional)</label>
                            <input type="number"
                                   name="referenceID"
                                   placeholder="Leave empty for general images"
                                   class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <p class="text-xs text-gray-500 mt-1">Only needed when uploading for specific product/category</p>
                        </div>
                        <div class="flex justify-end space-x-2">
                            <button type="button"
                                    class="bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400"
                                    data-bs-dismiss="modal">
                                Cancel
                            </button>
                            <button type="submit"
                                    class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                                <i class="fas fa-upload mr-2"></i>Upload
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

</div>

@section scripts {
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('imageUploadForm').addEventListener('submit', function (e) {
            e.preventDefault();
            var formData = new FormData(this);

            fetch('/Admin/UploadImage', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Uploaded!',
                            text: 'Image uploaded successfully',
                            timer: 1500,
                            showConfirmButton: false
                        }).then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: data.message
                        });
                    }
                });
        });
    </script>
}